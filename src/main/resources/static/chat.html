<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Spring AI èŠå¤©åŠ©æ‰‹</title>

    <!-- Markdownæ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>

    <style>
        /* ===== å…¨å±€æ ·å¼ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* ä¸»é¢˜é¢œè‰² */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --user-bubble: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --ai-bubble: #f7f8fc;
            --background: #f5f7fa;
            --card-background: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --success: #48bb78;
            --error: #f56565;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ===== ä¸»å®¹å™¨æ ·å¼ ===== */
        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            max-height: 800px;
            background: var(--card-background);
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== å¤´éƒ¨æ ·å¼ ===== */
        .chat-header {
            background: var(--primary-gradient);
            color: white;
            padding: 24px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }

        .chat-header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* ===== æ¶ˆæ¯åŒºåŸŸæ ·å¼ ===== */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }

        /* ===== æ¶ˆæ¯æ ·å¼ ===== */
        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 16px;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .message.user .message-avatar {
            background: var(--user-bubble);
        }

        .message.ai .message-avatar {
            background: var(--secondary-gradient);
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
        }

        .message.user .message-bubble {
            background: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-bubble {
            background: var(--ai-bubble);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 0 8px;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* ===== åŠ è½½åŠ¨ç”»æ ·å¼ ===== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
            background: var(--ai-bubble);
            border-radius: 18px;
            width: fit-content;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* ===== è¾“å…¥åŒºåŸŸæ ·å¼ ===== */
        .input-container {
            padding: 20px 30px 30px;
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        textarea {
            width: 100%;
            min-height: 50px;
            max-height: 150px;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-family: inherit;
            font-size: 15px;
            resize: none;
            transition: all 0.3s ease;
            background: var(--background);
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .char-count {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
        }

        button {
            padding: 14px 24px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            min-width: 100px;
            height: 50px;
            align-self: flex-start;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===== é”™è¯¯æç¤ºæ ·å¼ ===== */
        .error-message {
            background: #fff5f5;
            color: var(--error);
            padding: 12px 18px;
            border-radius: 8px;
            border-left: 4px solid var(--error);
            margin: 10px 0;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ===== æ¬¢è¿æ¶ˆæ¯æ ·å¼ ===== */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .welcome-message h2 {
            font-size: 28px;
            margin-bottom: 12px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-message p {
            font-size: 16px;
            line-height: 1.8;
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .chat-container {
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }

            .chat-header {
                padding: 20px;
            }

            .chat-header h1 {
                font-size: 20px;
            }

            .messages-container {
                padding: 20px;
            }

            .message-content {
                max-width: 85%;
            }

            .input-container {
                padding: 16px 20px 20px;
            }

            textarea {
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
            }

            button {
                min-width: 80px;
                padding: 14px 18px;
                height: 50px;
            }
        }

        @media (max-width: 480px) {
            .chat-header h1 {
                font-size: 18px;
            }

            .chat-header .status {
                font-size: 12px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .welcome-message h2 {
                font-size: 22px;
            }

            .welcome-message p {
                font-size: 14px;
            }
        }

        /* ===== Markdownæ ·å¼ ===== */
        .message-bubble.markdown-content {
            line-height: 1.7;
        }

        .message-bubble.markdown-content h1,
        .message-bubble.markdown-content h2,
        .message-bubble.markdown-content h3,
        .message-bubble.markdown-content h4,
        .message-bubble.markdown-content h5,
        .message-bubble.markdown-content h6 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.3;
        }

        .message-bubble.markdown-content h1 {
            font-size: 1.8em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        .message-bubble.markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 6px;
        }

        .message-bubble.markdown-content h3 {
            font-size: 1.3em;
        }

        .message-bubble.markdown-content h4 {
            font-size: 1.1em;
        }

        .message-bubble.markdown-content p {
            margin-bottom: 12px;
        }

        .message-bubble.markdown-content ul,
        .message-bubble.markdown-content ol {
            margin-bottom: 12px;
            padding-left: 24px;
        }

        .message-bubble.markdown-content li {
            margin-bottom: 6px;
        }

        .message-bubble.markdown-content blockquote {
            margin: 12px 0;
            padding: 8px 16px;
            border-left: 4px solid #667eea;
            background: rgba(102, 126, 234, 0.05);
            color: var(--text-primary);
            font-style: italic;
        }

        .message-bubble.markdown-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }

        .message-bubble.markdown-content pre {
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            background: #1e1e1e !important;
            position: relative;
        }

        .message-bubble.markdown-content pre code {
            display: block;
            padding: 40px 16px 16px 16px; /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œä¸ºè¯­è¨€æ ‡ç­¾ç•™å‡ºç©ºé—´ */
            overflow-x: auto;
            background: transparent;
            color: #d4d4d4;
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* ä»£ç å—å¤åˆ¶æŒ‰é’® */
        .code-block-wrapper {
            position: relative;
            margin: 12px 0;
        }

        .code-copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1;
        }

        .code-copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .code-copy-btn.copied {
            background: var(--success);
            border-color: var(--success);
        }

        .code-language {
            position: absolute;
            top: 8px;
            left: 12px;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            z-index: 1;
        }

        .message-bubble.markdown-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s ease;
        }

        .message-bubble.markdown-content a:hover {
            border-bottom-color: #667eea;
        }

        .message-bubble.markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .message-bubble.markdown-content th,
        .message-bubble.markdown-content td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        .message-bubble.markdown-content th {
            background: var(--background);
            font-weight: 600;
        }

        .message-bubble.markdown-content tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .message-bubble.markdown-content hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 20px 0;
        }

        .message-bubble.markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 12px 0;
        }

        /* ä¼˜åŒ–ç”¨æˆ·æ¶ˆæ¯ä¸­çš„Markdownï¼ˆå¦‚æœéœ€è¦ï¼‰ */
        .message.user .message-bubble.markdown-content code {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .message.user .message-bubble.markdown-content blockquote {
            border-left-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- å¤´éƒ¨ -->
        <div class="chat-header">
            <h1>
                <span>ğŸ¤–</span>
                <span>AI Chat Assistant</span>
            </h1>
            <div class="status">
                <span class="status-dot"></span>
                <span>åœ¨çº¿</span>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="messages-container" id="messagesContainer">
            <div class="welcome-message">
                <h2>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ AI Chat</h2>
                <p>æˆ‘æ˜¯åŸºäº Spring AI çš„æ™ºèƒ½åŠ©æ‰‹<br>éšæ—¶ä¸ºæ‚¨è§£ç­”é—®é¢˜å’Œæä¾›å¸®åŠ©</p>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-container">
            <div class="input-wrapper">
                <div class="input-field">
                    <textarea
                        id="messageInput"
                        placeholder="è¾“å…¥æ¶ˆæ¯... (æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ)"
                        rows="1"
                    ></textarea>
                    <div class="char-count">
                        <span id="charCount">0</span> / 2000
                    </div>
                </div>
                <button id="sendButton" onclick="sendMessage()">
                    å‘é€
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== å…¨å±€å˜é‡ =====
        let sessionId = null; // ä¼šè¯IDï¼Œç”¨äºä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡
        let isLoading = false; // æ˜¯å¦æ­£åœ¨åŠ è½½ä¸­

        // ===== DOM å…ƒç´  =====
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const charCount = document.getElementById('charCount');

        // ===== åˆå§‹åŒ– =====
        /**
         * é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
         */
        document.addEventListener('DOMContentLoaded', () => {
            // é…ç½®marked.js
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true, // æ”¯æŒæ¢è¡Œ
                    gfm: true, // å¯ç”¨GitHubé£æ ¼çš„Markdown
                    headerIds: false,
                    mangle: false
                });
            }

            // ç”Ÿæˆä¼šè¯ID
            sessionId = generateSessionId();

            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            messageInput.focus();

            // ä»æœ¬åœ°å­˜å‚¨æ¢å¤å†å²æ¶ˆæ¯
            loadChatHistory();
        });

        // ===== å·¥å…·å‡½æ•° =====
        /**
         * ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ID
         */
        function generateSessionId() {
            return `session_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        }

        /**
         * Markdownæ¸²æŸ“å‡½æ•°
         */
        function renderMarkdown(content) {
            if (typeof marked === 'undefined') {
                console.warn('marked.jsæœªåŠ è½½,ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º');
                return escapeHtml(content);
            }

            try {
                // ä½¿ç”¨markedæ¸²æŸ“Markdown
                let html = marked.parse(content);

                // å¤„ç†ä»£ç å—,æ·»åŠ å¤åˆ¶æŒ‰é’®å’Œè¯­è¨€æ ‡ç­¾
                html = addCodeBlockFeatures(html);

                return html;
            } catch (error) {
                console.error('Markdownæ¸²æŸ“é”™è¯¯:', error);
                return escapeHtml(content);
            }
        }

        /**
         * HTMLè½¬ä¹‰å‡½æ•°(ç”¨äºçº¯æ–‡æœ¬æ˜¾ç¤º)
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * ä¸ºä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®å’Œè¯­è¨€æ ‡ç­¾
         */
        function addCodeBlockFeatures(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // æŸ¥æ‰¾æ‰€æœ‰ä»£ç å—
            const codeBlocks = tempDiv.querySelectorAll('pre code');

            codeBlocks.forEach((codeBlock, index) => {
                const pre = codeBlock.parentElement;

                // æå–è¯­è¨€ä¿¡æ¯
                let language = 'text';
                const classNames = codeBlock.className.match(/language-(\w+)/);
                if (classNames && classNames[1]) {
                    language = classNames[1];
                }

                // åº”ç”¨ä»£ç é«˜äº®
                if (typeof hljs !== 'undefined') {
                    try {
                        if (language !== 'text' && hljs.getLanguage(language)) {
                            codeBlock.innerHTML = hljs.highlight(codeBlock.textContent, {
                                language: language
                            }).value;
                        } else {
                            codeBlock.innerHTML = hljs.highlightAuto(codeBlock.textContent).value;
                        }
                    } catch (e) {
                        console.warn('ä»£ç é«˜äº®å¤±è´¥:', e);
                    }
                }

                // åˆ›å»ºåŒ…è£…å™¨
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';

                // åˆ›å»ºè¯­è¨€æ ‡ç­¾
                if (language !== 'text') {
                    const langLabel = document.createElement('div');
                    langLabel.className = 'code-language';
                    langLabel.textContent = language;
                    wrapper.appendChild(langLabel);
                }

                // åˆ›å»ºå¤åˆ¶æŒ‰é’®
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-copy-btn';
                copyBtn.textContent = 'å¤åˆ¶';
                copyBtn.onclick = function(e) {
                    e.preventDefault();
                    copyCodeToClipboard(codeBlock.textContent, copyBtn);
                };

                wrapper.appendChild(copyBtn);

                // æ›¿æ¢åŸæ¥çš„preå…ƒç´ 
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);
            });

            return tempDiv.innerHTML;
        }

        /**
         * å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿
         */
        function copyCodeToClipboard(code, button) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showCopySuccess(button);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyToClipboard(code, button);
                });
            } else {
                fallbackCopyToClipboard(code, button);
            }
        }

        /**
         * å¤‡ç”¨å¤åˆ¶æ–¹æ³•(å…¼å®¹æ—§æµè§ˆå™¨)
         */
        function fallbackCopyToClipboard(code, button) {
            const textArea = document.createElement('textarea');
            textArea.value = code;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                showCopySuccess(button);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.textContent = 'å¤åˆ¶å¤±è´¥';
                setTimeout(() => {
                    button.textContent = 'å¤åˆ¶';
                }, 2000);
            }

            document.body.removeChild(textArea);
        }

        /**
         * æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
         */
        function showCopySuccess(button) {
            button.textContent = 'å·²å¤åˆ¶!';
            button.classList.add('copied');

            setTimeout(() => {
                button.textContent = 'å¤åˆ¶';
                button.classList.remove('copied');
            }, 2000);
        }

        /**
         * æ ¼å¼åŒ–æ—¶é—´æˆ³
         */
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();

            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');

            if (isToday) {
                return `${hours}:${minutes}`;
            } else {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}-${day} ${hours}:${minutes}`;
            }
        }

        /**
         * æ»šåŠ¨åˆ°åº•éƒ¨
         */
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * ä¿å­˜èŠå¤©å†å²åˆ°æœ¬åœ°å­˜å‚¨
         */
        function saveChatHistory() {
            const messages = [];
            const messageElements = messagesContainer.querySelectorAll('.message');

            messageElements.forEach(el => {
                if (!el.classList.contains('welcome-message')) {
                    const type = el.classList.contains('user') ? 'user' : 'ai';
                    const content = el.querySelector('.message-bubble').textContent;
                    const time = el.querySelector('.message-time').textContent;
                    messages.push({ type, content, time });
                }
            });

            localStorage.setItem(`chat_history_${sessionId}`, JSON.stringify(messages));
        }

        /**
         * ä»æœ¬åœ°å­˜å‚¨åŠ è½½èŠå¤©å†å²
         */
        function loadChatHistory() {
            const history = localStorage.getItem(`chat_history_${sessionId}`);
            if (history) {
                const messages = JSON.parse(history);
                messages.forEach(msg => {
                    addMessage(msg.content, msg.type, msg.time);
                });
            }
        }

        // ===== æ¶ˆæ¯å¤„ç† =====
        /**
         * æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
         */
        function addMessage(content, type = 'user', timestamp = null) {
            // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
            const welcomeMsg = messagesContainer.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            // å¯¹AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“,ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
            if (type === 'ai') {
                bubble.classList.add('markdown-content');
                bubble.innerHTML = renderMarkdown(content);
            } else {
                bubble.textContent = content;
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = timestamp || formatTime(Date.now());

            contentDiv.appendChild(bubble);
            contentDiv.appendChild(time);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            if (type === 'user' || type === 'ai') {
                saveChatHistory();
            }
        }

        /**
         * æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
         */
        function addLoadingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.id = 'loadingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ğŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

            contentDiv.appendChild(typingDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        /**
         * ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
         */
        function removeLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
         */
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `âŒ ${message}`;

            messagesContainer.appendChild(errorDiv);
            scrollToBottom();

            // 3ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æ¶ˆæ¯
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }

        /**
         * è®¾ç½®åŠ è½½çŠ¶æ€
         */
        function setLoading(loading) {
            isLoading = loading;
            messageInput.disabled = loading;
            sendButton.disabled = loading;
            sendButton.textContent = loading ? 'å‘é€ä¸­...' : 'å‘é€';
        }

        // ===== å‘é€æ¶ˆæ¯ =====
        /**
         * å‘é€æ¶ˆæ¯åˆ°åç«¯
         */
        async function sendMessage() {
            const message = messageInput.value.trim();

            // éªŒè¯è¾“å…¥
            if (!message) {
                messageInput.focus();
                return;
            }

            if (message.length > 2000) {
                showError('æ¶ˆæ¯é•¿åº¦ä¸èƒ½è¶…è¿‡ 2000 ä¸ªå­—ç¬¦');
                return;
            }

            if (isLoading) {
                return;
            }

            try {
                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                addMessage(message, 'user');
                messageInput.value = '';
                updateCharCount();

                // è®¾ç½®åŠ è½½çŠ¶æ€
                setLoading(true);
                addLoadingIndicator();

                // å‘é€è¯·æ±‚åˆ°åç«¯
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId
                    })
                });

                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                removeLoadingIndicator();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // æ›´æ–°ä¼šè¯IDï¼ˆå¦‚æœåç«¯è¿”å›äº†æ–°çš„ï¼‰
                if (data.sessionId) {
                    sessionId = data.sessionId;
                }

                // æ˜¾ç¤ºAIå›å¤
                const timestamp = data.timestamp ? formatTime(data.timestamp) : null;
                addMessage(data.reply, 'ai', timestamp);

            } catch (error) {
                console.error('Error:', error);
                removeLoadingIndicator();
                showError('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
            } finally {
                setLoading(false);
                messageInput.focus();
            }
        }

        // ===== äº‹ä»¶ç›‘å¬ =====
        /**
         * å¤„ç†é”®ç›˜äº‹ä»¶
         */
        messageInput.addEventListener('keydown', (e) => {
            // Enteré”®å‘é€æ¶ˆæ¯ï¼ˆä¸æŒ‰Shiftï¼‰
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        /**
         * è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
         */
        messageInput.addEventListener('input', () => {
            updateCharCount();

            // é‡ç½®é«˜åº¦ä»¥æ­£ç¡®è®¡ç®—scrollHeight
            messageInput.style.height = 'auto';

            // è®¾ç½®æ–°é«˜åº¦ï¼ˆé™åˆ¶æœ€å¤§é«˜åº¦ï¼‰
            const maxHeight = 150;
            const newHeight = Math.min(messageInput.scrollHeight, maxHeight);
            messageInput.style.height = newHeight + 'px';
        });

        /**
         * æ›´æ–°å­—ç¬¦è®¡æ•°
         */
        function updateCharCount() {
            const count = messageInput.value.length;
            charCount.textContent = count;

            // è¶…è¿‡é™åˆ¶æ—¶å˜çº¢
            if (count > 2000) {
                charCount.style.color = 'var(--error)';
            } else {
                charCount.style.color = 'var(--text-secondary)';
            }
        }

        /**
         * æ¸…é™¤èŠå¤©å†å²ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
         */
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <h2>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ AI Chat</h2>
                        <p>æˆ‘æ˜¯åŸºäº Spring AI çš„æ™ºèƒ½åŠ©æ‰‹<br>éšæ—¶ä¸ºæ‚¨è§£ç­”é—®é¢˜å’Œæä¾›å¸®åŠ©</p>
                    </div>
                `;
                localStorage.removeItem(`chat_history_${sessionId}`);
                sessionId = generateSessionId();
            }
        }
    </script>
</body>
</html>
