# 思考过程显示功能测试指南

## 📋 功能概述

本文档说明如何测试 stream-test.html 中新增的思考过程显示功能。该功能允许用户在与 GLM-4.6 模型对话时，实时查看模型的思考过程。

## ✅ 修复完成确认

### 前端修改
- ✅ 添加了思考过程容器样式（CSS）
- ✅ 修改了 `createAiMessageContainer()` 函数
- ✅ 添加了 3 个辅助函数（toggleReasoning, updateReasoningContent, showReasoningContainer）
- ✅ 修改了 `sendMessage()` 函数，切换到 `/api/chat/stream-enhanced` 端点
- ✅ 更新了功能特性说明

### 后端验证
- ✅ 诊断测试通过：成功提取 reasoning_content
- ✅ API 端点测试通过：正确发送 reasoning 和 content 事件
- ✅ 无需修改后端代码

## 🧪 测试步骤

### 1. 启动应用

```bash
cd E:\AI\spring-api-chat
mvn spring-boot:run -Dspring-boot.run.profiles=openai
```

等待应用启动完成，看到以下日志：
```
Tomcat started on port 8080 (http) with context path '/'
Started SpringApiChatApplication in X.XXX seconds
```

### 2. 访问测试页面

在浏览器中打开：
```
http://localhost:8080/stream-test.html
```

### 3. 基础功能测试

#### 测试 1：简单问候
**输入**：你好

**预期结果**：
1. 显示用户消息（紫色气泡，右对齐）
2. 显示 AI 消息容器
3. **思考过程区域**（淡蓝色渐变背景）：
   - 标题："▼ 思考过程"
   - 内容：显示模型的思考过程（如"收到用户发来的'你好'这样简单的问候..."）
   - 自动展开显示
4. **回复内容区域**：
   - 逐字显示 AI 的回复
5. 会话 ID 显示在页面底部

#### 测试 2：折叠/展开功能
**操作**：点击"▼ 思考过程"标题

**预期结果**：
1. 第一次点击：思考内容折叠隐藏，图标旋转为 ▶
2. 第二次点击：思考内容展开显示，图标旋转为 ▼

#### 测试 3：复杂问题
**输入**：请详细解释什么是 Spring AI，以及它的核心功能有哪些？

**预期结果**：
1. 思考过程内容较长，出现滚动条
2. 思考内容使用等宽字体显示
3. 回复内容逐字显示
4. 页面自动滚动到最新内容

#### 测试 4：多轮对话
**操作**：连续提问 3 次

**预期结果**：
1. 每条消息都有独立的思考过程区域
2. 会话 ID 保持不变
3. 模型能记住之前的对话内容

#### 测试 5：错误处理
**操作**：停止后端服务，然后发送消息

**预期结果**：
1. 显示错误消息（红色背景）
2. 输入框恢复可用状态

## 🎨 视觉效果验证

### 思考过程容器样式
- **背景**：淡蓝色渐变（#f0f4ff → #f9f9fb）
- **边框**：左侧 4px 蓝色边框（#667eea）
- **阴影**：轻微阴影效果
- **最大高度**：250px（超出显示滚动条）

### 思考内容样式
- **字体**：等宽字体（Monaco, Menlo, Ubuntu Mono）
- **字号**：13px
- **颜色**：深灰色（#555）
- **背景**：半透明白色（rgba(255, 255, 255, 0.6)）
- **内边距**：8px
- **最大高度**：200px（超出显示滚动条）

### 交互效果
- **标题悬停**：鼠标指针变为手型
- **折叠动画**：图标旋转动画（0.2s）
- **自动滚动**：新内容出现时自动滚动到底部

## 🔍 调试方法

### 1. 浏览器控制台
打开浏览器开发者工具（F12），查看 Console 标签：

**正常日志**：
```
收到思考内容，长度: 2
收到思考内容，长度: 2
收到思考内容，长度: 4
...
获取到会话ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

**错误日志**：
```
解析数据失败 SyntaxError: ...
Error: HTTP error! status: 500
```

### 2. 网络请求
在开发者工具的 Network 标签中：

1. 找到 `stream-enhanced` 请求
2. 查看 Response 标签
3. 应该看到 SSE 格式的响应：
```
event:reasoning
data:{"type":"reasoning","data":"..."}

event:content
data:{"type":"content","data":"..."}

event:done
data:{"type":"done","sessionId":"..."}
```

### 3. 后端日志
查看应用控制台输出：

**正常日志**：
```
ChatService.chatStreamEnhanced - 使用会话ID: xxx, 消息: 你好
[DEBUG] Metadata keys: [role, messageType, finishReason, reasoningContent, ...]
[DEBUG] reasoningContent = 收到
[DEBUG] 发送思考内容，长度: 2
[DEBUG] 发送回复内容，长度: 1
```

## 📊 测试检查清单

- [ ] 思考过程正确显示
- [ ] 思考内容可以折叠/展开
- [ ] AI 回复逐字显示
- [ ] 会话 ID 正确保存和显示
- [ ] 多轮对话记忆功能正常
- [ ] 长内容出现滚动条
- [ ] 页面自动滚动到最新内容
- [ ] 错误情况正确提示
- [ ] 样式符合设计要求
- [ ] 浏览器控制台无错误

## 🐛 常见问题

### 问题 1：思考过程不显示
**可能原因**：
1. 后端未启用 `enable_thinking: true`
2. API 端点错误（应该是 `/api/chat/stream-enhanced`）
3. 前端 JavaScript 解析错误

**解决方法**：
1. 检查 `application-openai.yaml` 配置
2. 查看浏览器控制台是否有错误
3. 查看网络请求的响应内容

### 问题 2：思考内容显示乱码
**可能原因**：
1. 字符编码问题
2. JSON 解析错误

**解决方法**：
1. 确认文件编码为 UTF-8
2. 查看浏览器控制台错误信息

### 问题 3：折叠/展开功能不工作
**可能原因**：
1. JavaScript 函数未正确绑定
2. DOM 元素 ID 冲突

**解决方法**：
1. 检查 `toggleReasoning()` 函数是否正确定义
2. 确认 `reasoningContent` ID 唯一

### 问题 4：会话 ID 未保存
**可能原因**：
1. `done` 事件未正确处理
2. sessionId 字段缺失

**解决方法**：
1. 查看网络请求中的 `done` 事件
2. 检查 `sessionId` 变量是否正确赋值

## 📝 测试报告模板

```markdown
## 测试报告

**测试日期**：YYYY-MM-DD
**测试人员**：XXX
**浏览器**：Chrome/Firefox/Edge 版本号

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 思考过程显示 | ✅/❌ | |
| 折叠/展开功能 | ✅/❌ | |
| 逐字显示 | ✅/❌ | |
| 会话记忆 | ✅/❌ | |
| 错误处理 | ✅/❌ | |
| 样式效果 | ✅/❌ | |

### 发现的问题

1. 问题描述
   - 重现步骤
   - 预期结果
   - 实际结果
   - 截图（如有）

### 建议

（如有改进建议）
```

## 🎯 性能测试

### 1. 响应时间
- 首次响应时间：< 1 秒
- 思考内容显示延迟：< 100ms
- 回复内容显示延迟：< 100ms

### 2. 内存使用
- 打开页面后内存占用：< 50MB
- 10 轮对话后内存占用：< 100MB

### 3. 网络流量
- 单次对话流量：< 10KB（不含 API 响应）
- SSE 连接稳定性：无断连

## 📚 相关文档

- [Spring AI 官方文档](https://docs.spring.io/spring-ai/reference/)
- [GLM-4.6 API 文档](https://open.bigmodel.cn/dev/api)
- [Server-Sent Events 规范](https://html.spec.whatwg.org/multipage/server-sent-events.html)

## 🔗 相关文件

- **前端**：`src/main/resources/static/stream-test.html`
- **后端控制器**：`src/main/java/com/lxq/spring_api_chat/chat/controller/ChatController.java`
- **服务层**：`src/main/java/com/lxq/spring_api_chat/chat/service/ChatService.java`
- **DTO**：`src/main/java/com/lxq/spring_api_chat/chat/dto/StreamChunk.java`
- **配置**：`src/main/resources/application-openai.yaml`
- **诊断测试**：`src/test/java/com/lxq/spring_api_chat/chat/service/ReasoningContentDiagnosticTest.java`

---

**最后更新**：2025-12-17
**维护者**：Claude Code Assistant
